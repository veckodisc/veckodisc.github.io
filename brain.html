<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>The Second Brain</title>
		<link rel="stylesheet" href="css/brain.css">
		<script src="js/utils.js"></script>
		<script src="js/models.js"></script>
	</head>
	<body>
		<img class="axis_info" id="axis_info" src="images/cube_axis.png" alt="Axis explanation">
		<img class="info_button" id="info_button" src="images/info.png" alt="Show info">
		
		<h1 id='title'></h1>
		<div class='info'>
			<div id='info-container' class='connection-container'>
				<img class="arrow" id="left_button" src="/images/left.png" alt="Left button">
				<h3 id='section_title_pres'></h3>
				<img class="arrow" id="right_button" src="/images/right.png" alt="Right button">
			</div>
			<h3 id='section_title'></h3>
			<p id='section_intro'></p>
		</div>
		
		<script type="module">
			
		    import * as THREE from 'https://cdn.skypack.dev/three@0.136.0/build/three.module.js';
		    import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js';
		    import { GLTFLoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/GLTFLoader.js';
		    import { FontLoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/FontLoader.js';
		    import { TextGeometry } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/geometries/TextGeometry.js';
		    
		    const start_color = [255, 5, 5];
		    const end_color = [0, 50, 255];
		    
		    const scene = new THREE.Scene();
		    const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
		    const renderer = new THREE.WebGLRenderer( { antialias: true } );
		    const geometry = new THREE.BoxGeometry();
		    
		    let cubes = JSON.parse(localStorage.getItem("cubes"));
		    let current_cube;
		    for (let i = 0; i < cubes.length; i++) {
				if(cubes[i].id == localStorage.getItem("current_cube")) {
					current_cube = cubes[i];
				}
			}
			document.getElementById("title").innerHTML = current_cube.title;
			if (parseInt(localStorage.getItem("pres_idx")) >= 0) {
				current_cube = JSON.parse(localStorage.getItem("pres_cube"));
				showPresentation(parseInt(localStorage.getItem("pres_idx")), current_cube)
			}
			
		    const controls = new OrbitControls( camera, renderer.domElement );
		    const gltfLoader = new GLTFLoader();
		    
		    const color = 0xFFFFFF;
		    const intensity = 1;
		    const light = new THREE.DirectionalLight(color, intensity);
		    light.position.set(-1, 2, 4);
		    scene.add(light);	
		    scene.add( new THREE.AmbientLight( 0xffffff, 0.4 ) );
			
		    let objects = [];
		    let secs = current_cube.sections;
		    for (let pos = 0; pos < secs.length; pos++) {
		    	const cube_color = getColor(current_cube, secs[pos]);
		    	const material = new THREE.MeshPhongMaterial( cube_color );
		    	const cube = new THREE.Mesh( geometry, material );
		    	let x = 1;
		    	let y = 1;
		    	let z = 1;
		    	if (pos % 3 == 0) {
					x = -1;
				} else if (pos % 3 == 1) {
					x = 0;
				}
				if (Math.floor(pos / 3) % 3 == 0) {
					y = -1;
				} else if (Math.floor(pos / 3) % 3 == 1) {
					y = 0;
				}
				if (Math.floor(pos / 9) == 0) {
					z = -1;
				} else if (Math.floor(pos / 9) == 1) {
					z = 0;
				}
				const gap = 1.26;
				cube.position.set( x * gap, y * gap, z * gap );
				cube.material.transparent = true;
		    	cube.material.opacity = 0.85; 
		    	if(!secs[pos].active) {
		    		cube.material.opacity = 0.35; 
		    	}
		    	cube.userData = {
                	id: secs[pos].id,
                	title: secs[pos].title,
                	intro: secs[pos].intro,
                	active: secs[pos].active,
                	strength: getStrength(current_cube, secs[pos])
            	};
            	scene.add( cube );
            	objects.push(cube);
		    }
		    
		    camera.position.set(4.5,3.8,4.5);
		    camera.lookAt(new THREE.Vector3(0,0,0)); 
		    let raycaster = new THREE.Raycaster();
		    let mouse = new THREE.Vector2();
		    renderer.setPixelRatio(window.devicePixelRatio);
		    
		    renderer.setSize( window.innerWidth, window.innerHeight );
		    document.body.appendChild( renderer.domElement );
		    

			window.addEventListener( 'resize', onWindowResize );
		    
		    document.addEventListener( 'dblclick', onDocumentDoubleClicked, false );
		    document.addEventListener("mousedown", onMouseDown);
		    document.getElementById("info_button").addEventListener("click", toggleInfo);
		    
		    document.getElementById("left_button").addEventListener('click', (() => {
		    	let idx = parseInt(localStorage.getItem("pres_idx"));
				if(idx == 0) {
					idx = 8;
				} else {
					idx -= 1;
				}
				localStorage.setItem("pres_idx", idx + "");
				location.reload();
			}));
			
			document.getElementById("right_button").addEventListener('click', (() => {
				let idx = parseInt(localStorage.getItem("pres_idx"));
				idx = (idx + 1) % 9;
				localStorage.setItem("pres_idx", idx + "");
				location.reload();
			}));
		    
		    function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}

			
			
			function onDocumentDoubleClicked(event) {
				if (parseInt(localStorage.getItem("pres_idx")) < 0) {
					event.preventDefault();
					mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
					mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
					raycaster.setFromCamera( mouse, camera );
					var intersects = raycaster.intersectObjects( objects );
					if (intersects.length > 0) {
		    			localStorage.setItem('current_section', intersects[0].object.userData.id);
		    			window.location.href = "section.html";
					}
    			}
			}
			
			function onMouseDown(event) {
    			event.preventDefault();
    			mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
				mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
    			raycaster.setFromCamera( mouse, camera );
				var intersects = raycaster.intersectObjects( objects );
				for (let i = 0; i < objects.length; i++) {
					let opacity;
					if(objects[i].userData.active) {
						opacity = 0.85;
					} else {
						opacity = 0.35;
					}
    				const material = new THREE.MeshPhongMaterial( { color: "#ff0000" } );
    				material.color = objects[i].material.color;
    				material.transparent = true;
    				material.opacity = opacity; 
    				objects[i].material = material;
    			}
    			if (intersects.length > 0) {
        			document.getElementById("section_title").innerHTML = intersects[0].object.userData.title;
        			document.getElementById("section_intro").innerHTML = intersects[0].object.userData.intro;
        			intersects[0].object.material.opacity = 1; 
        			if(intersects[0].object.userData.active) {
        				intersects[0].object.material.emissive = intersects[0].object.material.color; 
        				document.getElementById("section_title").innerHTML += " (" + intersects[0].object.userData.strength + "&nbsp%)";
        			} else {
        				document.getElementById("section_title").innerHTML += " (Inaktiv)";
        				intersects[0].object.material.opacity = 0.55; 
        			};
    			}
			}

			function toggleInfo(event) {
    			event.preventDefault();
    			let axis_info = document.getElementById("axis_info");
				if (parseInt(localStorage.getItem("pres_idx")) < 0) {
					localStorage.setItem("pres_idx", "0");
					let pres_cube = new_std_cube("");
					localStorage.setItem("pres_cube", JSON.stringify(pres_cube));
					location.reload();
				} else {
					localStorage.setItem("pres_idx", "-1");
					location.reload();
				}
			}
			
			function showPresentation(idx, cube) {
				axis_info.style.display = "block";
				let title = "Guide (";
				document.getElementById("left_button").style.display = "block";
				document.getElementById("right_button").style.display = "block";
				document.getElementById("info-container").style.alignItems = "center";
				document.getElementById("info-container").style.justifyContent = "center";
				document.getElementById("section_title_pres").style.textAlign = "center";
				document.getElementById("section_title_pres").style.textAlign = "center";
				document.getElementById("section_title_pres").style.width = "200px";
				switch (idx) {
					case 0:
						document.getElementById("section_title_pres").innerHTML = "Förutsättningar";
						document.getElementById("section_intro").innerHTML = "";
						title += (idx + 1) + "";
						for (let i = 0; i < cube.sections.length; i++) {
							if(Math.floor(i / 3) % 3 == 0) {
								cube.sections[i].active = 1;
							} else {
								cube.sections[i].active = 0;
							}
						}
					break;
					case 1:
						document.getElementById("section_title_pres").innerHTML = "Handlingsplaner";
						document.getElementById("section_intro").innerHTML = "";
						title += (idx + 1) + "";
						for (let i = 0; i < cube.sections.length; i++) {
							if(Math.floor(i / 3) % 3 == 1) {
								cube.sections[i].active = 1;
							} else {
								cube.sections[i].active = 0;
							}
						}
					break;
					case 2:
						document.getElementById("section_title_pres").innerHTML = "Mål och visioner";
						document.getElementById("section_intro").innerHTML = "";
						title += (idx + 1) + "";
						for (let i = 0; i < cube.sections.length; i++) {
							if(Math.floor(i / 3) % 3 == 2) {
								cube.sections[i].active = 1;
							} else {
								cube.sections[i].active = 0;
							}
						}
					break;
					case 3:
						document.getElementById("section_title_pres").innerHTML = "Historik";
						document.getElementById("section_intro").innerHTML = "";
						title += (idx + 1) + "";
						for (let i = 0; i < cube.sections.length; i++) {
							if(i % 3 == 0) {
								cube.sections[i].active = 1;
							} else {
								cube.sections[i].active = 0;
							}
						}
					break;
					case 4:
						document.getElementById("section_title_pres").innerHTML = "Fakta";
						document.getElementById("section_intro").innerHTML = "";
						title += (idx + 1) + "";
						for (let i = 0; i < cube.sections.length; i++) {
							if(i % 3 == 1) {
								cube.sections[i].active = 1;
							} else {
								cube.sections[i].active = 0;
							}
						}
					break;
					case 5:
						document.getElementById("section_title_pres").innerHTML = "Aktuellt";
						document.getElementById("section_intro").innerHTML = "";
						title += (idx + 1) + "";
						for (let i = 0; i < cube.sections.length; i++) {
							if(i % 3 == 2) {
								cube.sections[i].active = 1;
							} else {
								cube.sections[i].active = 0;
							}
						}
					break;
					case 6:
						document.getElementById("section_title_pres").innerHTML = "Individnivå";
						document.getElementById("section_intro").innerHTML = "";
						title += (idx + 1) + "";
						for (let i = 0; i < cube.sections.length; i++) {
							if(Math.floor(i / 9) == 0) {
								cube.sections[i].active = 1;
							} else {
								cube.sections[i].active = 0;
							}
						}
					break;
					case 7:
						document.getElementById("section_title_pres").innerHTML = "Gruppnivå";
						document.getElementById("section_intro").innerHTML = "";
						title += (idx + 1) + "";
						for (let i = 0; i < cube.sections.length; i++) {
							if(Math.floor(i / 9) == 1) {
								cube.sections[i].active = 1;
							} else {
								cube.sections[i].active = 0;
							}
						}
					break;
					case 8:
						document.getElementById("section_title_pres").innerHTML = "Organisationsnivå";
						document.getElementById("section_intro").innerHTML = "";
						title += (idx + 1) + "";
						for (let i = 0; i < cube.sections.length; i++) {
							if(Math.floor(i / 9) == 2) {
								cube.sections[i].active = 1;
							} else {
								cube.sections[i].active = 0;
							}
						}
					break;
				}
				title += "/9)";
				document.getElementById("title").innerHTML = title;
			}
			
			function restore_active() {
				let active_list = JSON.parse(localStorage.getItem("active_list"));
				let cube;
				let cubes = JSON.parse(localStorage.getItem("cubes"));
				for (let i = 0; i < cubes.length; i++) {
					if(cubes[i].id == localStorage.getItem("current_cube")) {
						cube = cubes[i];
					}
				}
				for (let i = 0; i < cube.sections.length; i++) {
					cube.sections[i].active = active_list[i];
				}
				localStorage.setItem("cubes", JSON.stringify(cubes));
				localStorage.setItem("pres_idx", "-1");
				location.reload();
			}
			
			function getColor(cube, section) {
				if(!section.active) {
					return {color: "#222"}
				}
				let strength = getStrength(cube, section);
				let r, g;
				let b = "00";
				if(strength <= 50) {
					r = "ff";
					g = (255 * strength) / 50;
					g = Math.round(g).toString(16);
					if(g.length == 1) {
						g = "0" + g;
					}
				} else {
					g = "ff";
					r = (255 * (100 - strength)) / 50;
					r = Math.round(r).toString(16);
					b = (50 * (strength - 50)) / 50;
					b = Math.round(b).toString(16);
					if(r.length == 1) {
						r = "0" + r;
					}
					if(b.length == 1) {
						b = "0" + b;
					}
				}
				
				let rr = Math.round(start_color[0] + ((end_color[0] - start_color[0]) / 100) * strength).toString(16);
				if(rr.length == 1) {
					rr = "0" + rr;
				}
				let gg = Math.round(start_color[1] + ((end_color[1] - start_color[1]) / 100) * strength).toString(16);
				if(gg.length == 1) {
					gg = "0" + gg;
				}
				let bb = Math.round(start_color[2] + ((end_color[2] - start_color[2]) / 100) * strength).toString(16);
				if(bb.length == 1) {
					bb = "0" + bb;
				}
				
				let colorString = "#" + r + g + b;
				colorString = "#" + rr + gg + bb;
				return {color: colorString};
			}

		    function animate() {
		        requestAnimationFrame( animate );
		        renderer.render( scene, camera );
		    }
		    animate();

		</script>
	</body>
</html>
